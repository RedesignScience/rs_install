#!/usr/bin/env python3

import subprocess
import shutil
from pathlib import Path
import os
import sys


def run(cmds):
    result = None
    for cmd in cmds.splitlines():
        if cmd:
            print(">>>>", cmd.lstrip())
            result = subprocess.run(cmd, shell=True)
    return result


def get_output_of_run(cmd):
    bytes = subprocess.check_output(cmd.split())
    text = bytes.decode("utf-8", errors="ignore")
    return text


def install_cmd(binary, install_cmd):
    if shutil.which(binary):
        print(f"Check binary: {binary} installed")
    else:
        print("Installing {binary}")
        run(install_cmd)


Path('rs').mkdir(exist_ok=True)
os.chdir("rs")

install_cmd(
    "brew",
    f'/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"'
)

install_cmd("wget", f"brew install wget")

if not shutil.which("conda"):
    # Must use x86 and rely on Rosetta
    fname = "Miniconda3-latest-MacOSX-x86_64.sh"
    if not Path(fname).exists():
        run("wget https://repo.anaconda.com/miniconda/Miniconda3-latest-MacOSX-x86_64.sh -O Miniconda3-latest-MacOSX-x86_64.sh")
        run("bash ./Miniconda3-latest-MacOSX-x86_64.sh -u")

    print("")
    print("Hopefully you've installed conda.")
    print("Now you need to restart the terminal to trigger conda.")
    print("")
    print("Restart the terminal and then come back to this directory.")
    print("Then restart the script and it will continue the installation.")
    sys.exit(1)

if run("conda env list | grep rs").returncode != 0:
    run("conda create -n rs -y python=3.8")

install_cmd("gh", f"brew install gh")

run("gh auth login")

install_cmd("git", f"brew install git")

package = "rs_install"
print(f">>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>")
print(f">> R_S Package: {package}")
if not Path(package).exists():
    run(f"gh repo clone RedesignScience/{package}")
os.chdir(package)
run("git pull")
os.chdir('..')

install_cmd("mamba", "conda install -y mamba")

run("mamba env update -n rs -f rs_install/rs_mac_conda_env.yaml")

text = get_output_of_run("conda env list")
pip = "pip"
for line in text.splitlines():
    print(line)
    tokens = line.split()
    if "rs" in tokens:
        pip = f"{tokens[-1]}/bin/pip"
        print(f"Found rs pip {pip}")
        break
else:
    print("Error: can't find rs conda environment")
    sys.exit(1)

for package in ["rsjob", "rseed", "foam", "foamdb", "AlphaSpace2"]:
    print(f">>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>")
    print(f">> R_S Package: {package}")

    if not Path(package).exists():
        run(f"gh repo clone RedesignScience/{package}")

    os.chdir(package)

    run(f"git pull")

    if package == "foamdb":
        run(f"{pip} install sqlalchemy alembic psycopg2-binary")
        run(f"{pip} install .")
    else:
        run(f"{pip} install -e .")

    os.chdir('..')


print("")
print("> conda activat"
      "e rs")
print()
print("> rseed")



